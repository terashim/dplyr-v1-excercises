# 13-1 ネストしたデータ構造の活用 その１ 数値シミュレーション

[`dplyr::rowwise`
のヘルプ](https://dplyr.tidyverse.org/reference/rowwise.html)
には、数値シミュレーションのデータをネスト構造で取り扱う例が示されている。

## データ構造

パラメータ (p, q) を様々な値に変えてデータ X を生成する数値シミュレーションを考える。
パラメータと生成されたデータの組をフラットなテーブルで表すなら次のような構造になる:

| シミュレーション番号 | パラメータp | パラメータq | 生成データX |
| :--------- | :----- | :----- | :----- |
| シミュレーション1  | 値 p1   | 値 q1   | x11    |
| シミュレーション1  | 値 p1   | 値 q1   | x12    |
| …          | …      | …      | …      |
| シミュレーション2  | 値 p2   | 値 q2   | x21    |
| シミュレーション2  | 値 p2   | 値 q2   | x22    |
| …          | …      | …      | …      |
| シミュレーション3  | 値 p3   | 値 q3   | x31    |
| シミュレーション3  | 値 p3   | 値 q3   | x32    |
| …          | …      | …      | …      |

一般に数値シミュレーションでは多数の値を発生させるので、このテーブルは重複による無駄が多い。

次のように階層化してデータXを折り込み、１行ごとに１回のシミュレーションを収めるほうがすっきりする。

| シミュレーション番号 | パラメータp | パラメータq | 生成データx         |
| :--------- | :----- | :----- | :------------- |
| シミュレーション1  | 値 p1   | 値 q1   | (x11, x12, … ) |
| シミュレーション2  | 値 p2   | 値 q2   | (x21, x22, … ) |
| シミュレーション3  | 値 p3   | 値 q3   | (x31, x32, … ) |
| …          | …      | …      | …              |

-----

## 例

``` r
library(tidyr)
library(dplyr)
```

    ## 
    ## Attaching package: 'dplyr'

    ## The following objects are masked from 'package:stats':
    ## 
    ##     filter, lag

    ## The following objects are masked from 'package:base':
    ## 
    ##     intersect, setdiff, setequal, union

``` r
params <- tribble(
 ~sim, ~n, ~mean, ~sd,
    1,  3,     1,   1,
    2,  5,     2,   4,
    3,  10,    -1,   2
)
```

このデータフレーム `params` は各行が１つのシミュレーション条件を表す

``` r
params
```

    ## # A tibble: 3 x 4
    ##     sim     n  mean    sd
    ##   <dbl> <dbl> <dbl> <dbl>
    ## 1     1     3     1     1
    ## 2     2     5     2     4
    ## 3     3    10    -1     2

例えば シミュレーション 1 では 平均値 mean = 1, 標準偏差 sd = 1 の正規分布から n = 3
個の乱数を発生させることを表している。

`dplyr` バージョン 1.0.0 `summarise()` では長さ２以上のベクトルになる関数が使えるので、次のようにして乱数 z
を作ることができる

``` r
params %>%
  group_by(sim) %>%
  summarise(
    n = n,
    mean = mean,
    sd = sd,
    z = rnorm(n, mean, sd)
  )
```

    ## `summarise()` regrouping output by 'sim' (override with `.groups` argument)

    ## # A tibble: 18 x 5
    ## # Groups:   sim [3]
    ##      sim     n  mean    sd      z
    ##    <dbl> <dbl> <dbl> <dbl>  <dbl>
    ##  1     1     3     1     1  1.12 
    ##  2     1     3     1     1  0.685
    ##  3     1     3     1     1 -0.414
    ##  4     2     5     2     4  9.45 
    ##  5     2     5     2     4 -4.35 
    ##  6     2     5     2     4  1.79 
    ##  7     2     5     2     4  5.37 
    ##  8     2     5     2     4  4.43 
    ##  9     3    10    -1     2 -2.51 
    ## 10     3    10    -1     2 -1.42 
    ## 11     3    10    -1     2 -1.01 
    ## 12     3    10    -1     2 -2.07 
    ## 13     3    10    -1     2 -2.98 
    ## 14     3    10    -1     2  0.287
    ## 15     3    10    -1     2  2.14 
    ## 16     3    10    -1     2 -3.79 
    ## 17     3    10    -1     2 -1.88 
    ## 18     3    10    -1     2 -1.05

これはフラットなテーブルによる数値シミュレーションの表現である。

乱数 z を１行ごとにネストさせるには、次のようにして `mutate()` でリスト型の列を作る

``` r
sim_data <-
  params %>%
  group_by(sim) %>%
  mutate(z = list(rnorm(n, mean, sd)))
```

この操作では次のようなリストを作って列 `z` にしている

``` r
list(
  rnorm(3, 1, 1),
  rnorm(5, 2, 4),
  rnorm(10, -1, 2)
)
```

    ## [[1]]
    ## [1]  2.4299305 -0.5926046  0.7444813
    ## 
    ## [[2]]
    ## [1] -0.2852304  4.5372745  5.4997072  5.2591636  1.7260953
    ## 
    ## [[3]]
    ##  [1]  0.02880069  2.65918879 -1.48585745  0.34006806 -4.38949828 -0.27308474
    ##  [7] -1.36123384 -3.09336512 -0.41882740 -2.51218787

作成されたデータは次のような構造になっている

``` r
sim_data
```

    ## # A tibble: 3 x 5
    ## # Groups:   sim [3]
    ##     sim     n  mean    sd z         
    ##   <dbl> <dbl> <dbl> <dbl> <list>    
    ## 1     1     3     1     1 <dbl [3]> 
    ## 2     2     5     2     4 <dbl [5]> 
    ## 3     3    10    -1     2 <dbl [10]>

１行が１つのシミュレーション・１組のパラメータを表し、シミュレーションで発生させた n個の乱数がネストされて１行に収められている。
