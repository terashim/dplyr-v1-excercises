---
title: "dplyr ver1 練習帳 - 01 select と mutate"
author: "terashim"
date: "2020/7/1"
output: 
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
# カスタムチャンクオプション out.lines を定義
# 参考 https://bookdown.org/yihui/rmarkdown-cookbook/hook-truncate.html
# save the built-in output hook
hook_output <- knitr::knit_hooks$get("output")

# set a new output hook to truncate text output
knitr::knit_hooks$set(output = function(x, options) {
  if (!is.null(n <- options$out.lines)) {
    x <- xfun::split_lines(x)
    if (length(x) > n) {
      # truncate the output
      x <- c(head(x, n/2), '....', tail(x, n/2 + 1))
    }
    x <- paste(x, collapse = "\n")
  }
  hook_output(x, options)
})
```


## パッケージのインストール

普通にCRANから dplyr パッケージをインストールするとバージョン 1.0 になる（2020年7月1日現在）

```{r eval=FALSE}
install.packages("dplyr")
```

インストールされた dplyr パッケージのバージョンを確認

```{r}
installed.packages()["dplyr", "Version"]
```

パッケージのロード

```{r}
library(dplyr)
```

-----

## 練習用データ

練習用データとして **`airquality`** を使う。

```{r out.lines=13}
airquality
```

---

## select() - 列選択・列名変更・列の並べ替え

### select() で列選択

select で列を選択

```{r out.lines=13}
airquality %>% 
  select(Solar.R, Temp, Month, Day)
```

列名は文字列でもOK

```{r out.lines=13}
airquality %>% 
  select("Solar.R", "Temp", "Month", "Day")
```
文字列ベクトルでもOK

```{r out.lines=13}
airquality %>% 
  select(c("Solar.R", "Temp", "Month", "Day"))
```

### select() で列の並べ替え

```{r out.lines=13}
airquality %>% 
  select(Month, Day, Solar.R, Temp)
```

### select() で列名変更

```{r out.lines=13}
airquality %>% 
  select(month = Month, day = Day, solar_radiation = Solar.R, temperature = Temp)
```

---

## mutate() - 列の追加・列の変更

### mutate で列の追加

このデータは1973年の観測値なので、**定数値 1973 の入った列 year を付け加える**

```{r out.lines=13}
airquality %>% 
  mutate(
    year = 1973
  )
```

年 year を作り、さらに月 Month, 日 Day の列と合わせて **日付の列 date を作る**

```{r out.lines=13}
airquality %>% 
  mutate(
    year = 1973,
    date = as.Date(sprintf("%04d-%02d-%02d", year, Month, Day))
  )
```

列 Temp は華氏温度で表した気温を表す。
この列を元に **摂氏温度に変換した列 temperature を作って付け加える**

```{r out.lines=13}
airquality %>% 
  mutate(
    temperature = (Temp - 32) / 1.8
  )
```

列 Wind は mph (マイル毎時) 単位で表した風速を表す。
この列を元に **メートル毎秒単位に変換した列 wind を作って付け加える**

```{r out.lines=13}
airquality %>% 
  mutate(
    wind = Wind * 1609 / 3600
  )
```

### mutate() で列を変更

気温 Temp を華氏温度から摂氏温度に変換して **上書き** する

```{r out.lines=13}
airquality %>% 
  mutate(
    Temp = (Temp - 32) / 1.8
  )
```
風速 Wind をマイル毎時からメートル毎秒に変換して **上書き** する

```{r out.lines=13}
airquality %>% 
  mutate(
    Wind = Wind * 1609 / 3600
  )
```

### select() と mutate() を組み合わせて使う

- 月 `Month`, 日 `Day` を元に日付の列 `date` を作る
- 華氏気温 `Temp` から摂氏気温の列 `temperaure` を作る
- マイル毎時単位の風速 `Wind` からメートル毎秒単位の風速 `wind` を作る
- 列名 `Month`, `Day`, `Ozone` を小文字に変更する
- 列名 `Solar.R` を `solar_radiation` に変更する
- 列を `date`, `month`, `day`, `ozone`, `solar_radiation`, `wind`, `temperature` の順に並べる

```{r out.lines=13}
airquality %>% 
  mutate(
    year = 1973,
    date = as.Date(sprintf("%04d-%02d-%02d", year, Month, Day)),
    temperature = (Temp - 32) / 1.8,
    wind = Wind * 1609 / 3600
  ) %>% 
  select(
    date,
    year,
    month = Month,
    day = Day,
    ozone = Ozone,
    solar_radiation = Solar.R,
    wind, 
    temperature
  )
```

