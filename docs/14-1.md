---
title: 'dplyr ver1 練習帳 - 13-1 ネストしたデータ構造の活用 その１ 数値シミュレーション'
author: "terashim"
date: "2020/7/14"
output:
  md_document:
    variant: gfm
---

# 13-1 ネストしたデータ構造の活用 その１ 数値シミュレーション

[`dplyr::rowwise` のヘルプ](https://dplyr.tidyverse.org/reference/rowwise.html) には、数値シミュレーションのデータをネスト構造で取り扱う例が示されている。

## データ構造

パラメータ (p, q) を様々な値に変えてデータ X を生成する数値シミュレーションを考える。
パラメータと生成されたデータの組をフラットなテーブルで表すなら次のような構造になる:

シミュレーション番号 | パラメータp | パラメータq | 生成データX
:--------------------|:------------|:------------|:------------
シミュレーション1    | 値 p1       | 値 q1       | x11
シミュレーション1    | 値 p1       | 値 q1       | x12
 ...                 | ...         | ...         | ...
シミュレーション2    | 値 p2       | 値 q2       | x21
シミュレーション2    | 値 p2       | 値 q2       | x22
 ...                 | ...         | ...         | ...
シミュレーション3    | 値 p3       | 値 q3       | x31
シミュレーション3    | 値 p3       | 値 q3       | x32
 ...                 | ...         | ...         | ...

一般に数値シミュレーションでは多数の値を発生させるので、このテーブルは重複による無駄が多い。

次のように階層化してデータXを折り込み、１行ごとに１回のシミュレーションを収めるほうがすっきりする。

シミュレーション番号 | パラメータp | パラメータq | 生成データx
:--------------------|:------------|:------------|:-----------------
シミュレーション1    | 値 p1       | 値 q1       | (x11, x12, ... )
シミュレーション2    | 値 p2       | 値 q2       | (x21, x22, ... )
シミュレーション3    | 値 p3       | 値 q3       | (x31, x32, ... )
 ...                 | ...         | ...         | ...

---

## 例


```r
library(tidyr)
library(dplyr)

params <- tribble(
 ~sim, ~n, ~mean, ~sd,
    1,  3,     1,   1,
    2,  5,     2,   4,
    3,  10,    -1,   2
)
```

このデータフレーム `params` は各行が１つのシミュレーション条件を表す


```r
params
```

```
## # A tibble: 3 x 4
##     sim     n  mean    sd
##   <dbl> <dbl> <dbl> <dbl>
## 1     1     3     1     1
## 2     2     5     2     4
## 3     3    10    -1     2
```

例えば シミュレーション 1 では 平均値 mean = 1, 標準偏差 sd = 1 の正規分布から n = 3 個の乱数を発生させることを表している。

`dplyr` バージョン 1.0.0 `summarise()` では長さ２以上のベクトルになる関数が使えるので、次のようにして乱数 z を作ることができる


```r
params %>%
  group_by(sim) %>%
  summarise(
    n = n,
    mean = mean,
    sd = sd,
    z = rnorm(n, mean, sd)
  )
```

```
## `summarise()` regrouping output by 'sim' (override with `.groups` argument)
```

```
## # A tibble: 18 x 5
## # Groups:   sim [3]
##      sim     n  mean    sd      z
##    <dbl> <dbl> <dbl> <dbl>  <dbl>
##  1     1     3     1     1 -0.283
##  2     1     3     1     1 -1.68 
##  3     1     3     1     1 -0.448
##  4     2     5     2     4 -5.00 
##  5     2     5     2     4 -3.78 
##  6     2     5     2     4 12.5  
##  7     2     5     2     4 -4.17 
##  8     2     5     2     4  2.89 
##  9     3    10    -1     2 -2.12 
## 10     3    10    -1     2 -0.741
## 11     3    10    -1     2  1.24 
## 12     3    10    -1     2 -1.89 
## 13     3    10    -1     2 -1.57 
## 14     3    10    -1     2 -2.59 
## 15     3    10    -1     2 -3.22 
## 16     3    10    -1     2 -3.85 
## 17     3    10    -1     2  1.33 
## 18     3    10    -1     2 -2.06
```

これはフラットなテーブルによる数値シミュレーションの表現である。

乱数 z を１行ごとにネストさせるには、次のようにして `mutate()` でリスト型の列を作る


```r
sim_data <-
  params %>%
  group_by(sim) %>%
  mutate(z = list(rnorm(n, mean, sd)))
```

この操作では次のようなリストを作って列 `z` にしている


```r
list(
  rnorm(3, 1, 1),
  rnorm(5, 2, 4),
  rnorm(10, -1, 2)
)
```

```
## [[1]]
## [1]  1.04641163 -1.10302530  0.08495599
## 
## [[2]]
## [1]  4.867552 -6.101791  4.765277  4.741290 -1.685367
## 
## [[3]]
##  [1] -2.7690826  2.7129710  1.7447271 -0.5151368 -2.8015388 -2.5242239
##  [7]  0.3391797  0.8370896 -5.5658762 -2.5574529
```

作成されたデータは次のような構造になっている


```r
sim_data
```

```
## # A tibble: 3 x 5
## # Groups:   sim [3]
##     sim     n  mean    sd z         
##   <dbl> <dbl> <dbl> <dbl> <list>    
## 1     1     3     1     1 <dbl [3]> 
## 2     2     5     2     4 <dbl [5]> 
## 3     3    10    -1     2 <dbl [10]>
```

１行が１つのシミュレーション・１組のパラメータを表し、シミュレーションで発生させた n個の乱数がネストされて１行に収められている。
