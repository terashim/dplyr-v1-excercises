---
title: "dplyr ver1 練習帳"
author: "terashim"
date: "2020/7/1"
output:
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
# カスタムチャンクオプション out.lines を定義
# 参考 https://bookdown.org/yihui/rmarkdown-cookbook/hook-truncate.html
# save the built-in output hook
hook_output <- knitr::knit_hooks$get("output")

# set a new output hook to truncate text output
knitr::knit_hooks$set(output = function(x, options) {
  if (!is.null(n <- options$out.lines)) {
    x <- xfun::split_lines(x)
    if (length(x) > n) {
      # truncate the output
      x <- c(head(x, n/2), '....', tail(x, n/2 + 1))
    }
    x <- paste(x, collapse = "\n")
  }
  hook_output(x, options)
})
```


## パッケージのインストール

普通にCRANから dplyr パッケージをインストールするとバージョン 1.0 になる（2020年7月1日現在）

```{r eval=FALSE}
install.packages("dplyr")
```

インストールされた dplyr パッケージのバージョンを確認

```{r}
installed.packages()["dplyr", "Version"]
```

パッケージのロード

```{r}
library(dplyr)
```

-----

## 練習用データ

練習用データとして **`airquality`** を使う。

```{r out.lines=13}
airquality
```

---

## select() - 列選択・列名変更・列の並べ替え

### select() で列選択

select で列を選択

```{r out.lines=13}
airquality %>% 
  select(Solar.R, Temp, Month, Day)
```

列名は文字列でもOK

```{r out.lines=13}
airquality %>% 
  select("Solar.R", "Temp", "Month", "Day")
```
文字列ベクトルでもOK

```{r out.lines=13}
airquality %>% 
  select(c("Solar.R", "Temp", "Month", "Day"))
```

### select() で列の並べ替え

```{r out.lines=13}
airquality %>% 
  select(Month, Day, Solar.R, Temp)
```

### select() で列名変更

```{r out.lines=13}
airquality %>% 
  select(month = Month, day = Day, solar_radiation = Solar.R, temperature = Temp)
```

---

## mutate() - 列の追加・列の変更

### mutate で列の追加

このデータは1973年の観測値なので、**定数値 1973 の入った列 year を付け加える**

```{r out.lines=13}
airquality %>% 
  mutate(
    year = 1973
  )
```

年 year を作り、さらに月 Month, 日 Day の列と合わせて **日付の列 date を作る**

```{r out.lines=13}
airquality %>% 
  mutate(
    year = 1973,
    date = as.Date(sprintf("%04d-%02d-%02d", year, Month, Day))
  )
```

列 Temp は華氏温度で表した気温を表す。
この列を元に **摂氏温度に変換した列 temperature を作って付け加える**

```{r out.lines=13}
airquality %>% 
  mutate(
    temperature = (Temp - 32) / 1.8
  )
```

列 Wind は mph (マイル毎時) 単位で表した風速を表す。
この列を元に **メートル毎秒単位に変換した列 wind を作って付け加える**

```{r out.lines=13}
airquality %>% 
  mutate(
    wind = Wind * 1609 / 3600
  )
```

### mutate() で列を変更

気温 Temp を華氏温度から摂氏温度に変換して **上書き** する

```{r out.lines=13}
airquality %>% 
  mutate(
    Temp = (Temp - 32) / 1.8
  )
```
風速 Wind をマイル毎時からメートル毎秒に変換して **上書き** する

```{r out.lines=13}
airquality %>% 
  mutate(
    Wind = Wind * 1609 / 3600
  )
```

### select() と mutate() を組み合わせて使う

- 月 `Month`, 日 `Day` を元に日付の列 `date` を作る
- 華氏気温 `Temp` から摂氏気温の列 `temperaure` を作る
- マイル毎時単位の風速 `Wind` からメートル毎秒単位の風速 `wind` を作る
- 列名 `Month`, `Day`, `Ozone` を小文字に変更する
- 列名 `Solar.R` を `solar_radiation` に変更する
- 列を `date`, `month`, `day`, `ozone`, `solar_radiation`, `wind`, `temperature` の順に並べる

```{r out.lines=13}
airquality %>% 
  mutate(
    year = 1973,
    date = as.Date(sprintf("%04d-%02d-%02d", year, Month, Day)),
    temperature = (Temp - 32) / 1.8,
    wind = Wind * 1609 / 3600
  ) %>% 
  select(
    date,
    year,
    month = Month,
    day = Day,
    ozone = Ozone,
    solar_radiation = Solar.R,
    wind, 
    temperature
  )
```

---

## 集計

### 整形したデータ

`select()` と `mutate()` で整形したデータ **`airquality_mod`** を用意する. また data.frame を tibble にする.

```{r}
airquality_mod <-
  airquality %>% 
  mutate(
    year = 1973,
    date = as.Date(sprintf("%04d-%02d-%02d", year, Month, Day)),
    temperature = (Temp - 32) / 1.8
  ) %>% 
  select(
    date,
    year,
    month = Month,
    day = Day,
    ozone = Ozone,
    solar_radiation = Solar.R,
    wind = Wind, 
    temperature
  ) %>% 
  as_tibble()

airquality_mod
```

### `summarise()` で全体の平均値を取る

`wind`, `temperature` の平均値を計算して `avg_wind`, `avg_temperature` とする.

```{r}
airquality_mod %>% 
  summarise(
    avg_wind = mean(wind),
    avg_temperature = mean(temperature)
  )
```

### `group_by()` と `summarise()` でグループごとに平均値を取る

`month` でグループ化してから `wind`, `temperature` の平均値を計算する

```{r}
airquality_mod %>% 
  group_by(month) %>% 
  summarise(avg_wind = mean(wind), avg_temperature = mean(temperature))
```

ここで、`month` によるグループ化が `summarise()` によって解除される旨の警告メッセージが表示される。
これはバージョン 1.0.0 での変更点である。

---

## グループ化とグループ解除

ここでグループ化と解除の挙動について少し深入り。

### グループ化されたデータを表示する

グループ化前

```{r}
airquality_mod
```

グループ化後

```{r}
airquality_mod %>% 
  group_by(month)
```

`gropu_by()` によってデータ本体は変わらず、グループ化されたことを表す情報表示 `# Groups:   month [5]` が出る。

### `groups()` でグループ化の状態を確認する

`groups()` 関数を使うとグループ化の状態が確認できる.

グループ化しないとき

```{r}
airquality_mod %>% groups()
```

列 `month` でグループ化したとき

```{r}
airquality_mod %>% 
  group_by(month) %>%
  groups()
```

列 `year` と `month` でグループ化したとき

```{r}
airquality_mod %>% 
  group_by(year, month) %>%
  groups()
```

### `ungroup()` でグループ化を解除する

グループ化されたデータ `grouped_data` を作る

```{r}
grouped_data <-
  airquality_mod %>% 
  group_by(year, month)
```

グループ化の状態を表示

```{r}
grouped_data %>% groups()
```
`ungroup()` でグループ化を解除したデータ `ungrouped_data` を作成

```{r}
ungrouped_data <-
  grouped_data %>%
  ungroup()
```

グループ化されていないことを確認

```{r}
ungrouped_data %>% groups()
```
データの中身は最初と変わっていない

```{r}
ungrouped_data
```

### `summarise()` した後のグルーピングを確認する

ここで `summarise()` によるグループ化解除の挙動を実験する

#### (1) `month` でグループ化した後、 `summarise()` する

```{r}
airquality_mod %>% 
  group_by(month) %>% 
  summarise(avg_wind = mean(wind), avg_temperature = mean(temperature)) %>% 
  groups()
```

メッセージの通り、**グループ化が解除されている.**

#### (2) `year`, `month` でグループ化した後、 `summarise()` する

```{r}
airquality_mod %>% 
  group_by(year, month) %>% 
  summarise(avg_wind = mean(wind), avg_temperature = mean(temperature)) %>% 
  groups()
```

`month` によるグループ化が解除され、**`year` によるグループ化が残っている**

#### (3) `month`, `year` の順でグループ化した後、 `summarise()` する

```{r}
airquality_mod %>% 
  group_by(month, year) %>% 
  summarise(avg_wind = mean(wind), avg_temperature = mean(temperature)) %>% 
  groups()
```

`year` によるグループ化が解除され、**`month` によるグループ化が残っている**

**解除されるグループはグループ化の順序によって変わる.**

### 【v1.0新機能】 `.groups = "drop"` で `summarise` しながらグループ化を全て解除

`summarise()` の後にグループ化の状態を残したくないとき、オプションで `.groups = "drop"` と指定すればすべてのグループ化を解除できるようになった. 

```{r}
airquality_mod %>% 
  group_by(month, year) %>% 
  summarise(avg_wind = mean(wind), avg_temperature = mean(temperature), .groups = "drop") %>% 
  groups()
```

**`.groups` はまだ "実験的な" API という位置づけになっている** ので、今後のバージョンで変更される可能性がある。

