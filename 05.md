ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ãƒ‰

``` r
library(dplyr)
library(nycflights13)
```

ã“ã“ã§ã¯èˆªç©ºä¾¿ãƒ‡ãƒ¼ã‚¿ `flights` ã¨èˆªç©ºæ©Ÿãƒ‡ãƒ¼ã‚¿ `planes` ã®ï¼’ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

``` r
flights
```

    ## # A tibble: 336,776 x 19
    ##     year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
    ##    <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
    ##  1  2013     1     1      517            515         2      830            819
    ##  2  2013     1     1      533            529         4      850            830
    ##  3  2013     1     1      542            540         2      923            850
    ##  4  2013     1     1      544            545        -1     1004           1022
    ##  5  2013     1     1      554            600        -6      812            837
    ##  6  2013     1     1      554            558        -4      740            728
    ##  7  2013     1     1      555            600        -5      913            854
    ##  8  2013     1     1      557            600        -3      709            723
    ##  9  2013     1     1      557            600        -3      838            846
    ## 10  2013     1     1      558            600        -2      753            745
    ## # â€¦ with 336,766 more rows, and 11 more variables: arr_delay <dbl>,
    ## #   carrier <chr>, flight <int>, tailnum <chr>, origin <chr>, dest <chr>,
    ## #   air_time <dbl>, distance <dbl>, hour <dbl>, minute <dbl>, time_hour <dttm>

``` r
planes
```

    ## # A tibble: 3,322 x 9
    ##    tailnum  year type          manufacturer   model  engines seats speed engine 
    ##    <chr>   <int> <chr>         <chr>          <chr>    <int> <int> <int> <chr>  
    ##  1 N10156   2004 Fixed wing mâ€¦ EMBRAER        EMB-1â€¦       2    55    NA Turbo-â€¦
    ##  2 N102UW   1998 Fixed wing mâ€¦ AIRBUS INDUSTâ€¦ A320-â€¦       2   182    NA Turbo-â€¦
    ##  3 N103US   1999 Fixed wing mâ€¦ AIRBUS INDUSTâ€¦ A320-â€¦       2   182    NA Turbo-â€¦
    ##  4 N104UW   1999 Fixed wing mâ€¦ AIRBUS INDUSTâ€¦ A320-â€¦       2   182    NA Turbo-â€¦
    ##  5 N10575   2002 Fixed wing mâ€¦ EMBRAER        EMB-1â€¦       2    55    NA Turbo-â€¦
    ##  6 N105UW   1999 Fixed wing mâ€¦ AIRBUS INDUSTâ€¦ A320-â€¦       2   182    NA Turbo-â€¦
    ##  7 N107US   1999 Fixed wing mâ€¦ AIRBUS INDUSTâ€¦ A320-â€¦       2   182    NA Turbo-â€¦
    ##  8 N108UW   1999 Fixed wing mâ€¦ AIRBUS INDUSTâ€¦ A320-â€¦       2   182    NA Turbo-â€¦
    ##  9 N109UW   1999 Fixed wing mâ€¦ AIRBUS INDUSTâ€¦ A320-â€¦       2   182    NA Turbo-â€¦
    ## 10 N110UW   1999 Fixed wing mâ€¦ AIRBUS INDUSTâ€¦ A320-â€¦       2   182    NA Turbo-â€¦
    ## # â€¦ with 3,312 more rows

-----

## left\_join() - å·¦çµåˆ

SQL ã® LEFT JOIN ã«ç›¸å½“ã™ã‚‹ã€‚

`flights` ã«å¯¾ã—ã¦ `planes` ã‚’å·¦çµåˆã™ã‚‹ã€‚ãã®éš›ã€åˆ— `tailnum` (æ©Ÿä½“ç•ªå·) ã‚’çµåˆã‚­ãƒ¼ã¨ã™ã‚‹ã€‚

``` r
flights %>% 
  left_join(planes, by = "tailnum")
```

    ## # A tibble: 336,776 x 27
    ##    year.x month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
    ##     <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
    ##  1   2013     1     1      517            515         2      830            819
    ##  2   2013     1     1      533            529         4      850            830
    ##  3   2013     1     1      542            540         2      923            850
    ##  4   2013     1     1      544            545        -1     1004           1022
    ##  5   2013     1     1      554            600        -6      812            837
    ##  6   2013     1     1      554            558        -4      740            728
    ##  7   2013     1     1      555            600        -5      913            854
    ##  8   2013     1     1      557            600        -3      709            723
    ##  9   2013     1     1      557            600        -3      838            846
    ## 10   2013     1     1      558            600        -2      753            745
    ## # â€¦ with 336,766 more rows, and 19 more variables: arr_delay <dbl>,
    ## #   carrier <chr>, flight <int>, tailnum <chr>, origin <chr>, dest <chr>,
    ## #   air_time <dbl>, distance <dbl>, hour <dbl>, minute <dbl>, time_hour <dttm>,
    ## #   year.y <int>, type <chr>, manufacturer <chr>, model <chr>, engines <int>,
    ## #   seats <int>, speed <int>, engine <chr>

ã“ã®ã¨ãèˆªç©ºä¾¿ã®å¹´ `fligts$year` ã¨èˆªç©ºæ©Ÿã®è£½é€ å¹´ `planes$year` ã§åˆ—åãŒé‡è¤‡ã—ã¦ã„ã‚‹ã€‚
ã“ã‚Œã‚’åŒºåˆ¥ã™ã‚‹ãŸã‚ã®ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ `.x`, `.y` ãŒè‡ªå‹•çš„ã«ä»˜ä¸ã•ã‚Œã‚‹ã€‚

``` r
flights %>% 
  left_join(planes, by = "tailnum") %>% 
  select(year.x, year.y)
```

    ## # A tibble: 336,776 x 2
    ##    year.x year.y
    ##     <int>  <int>
    ##  1   2013   1999
    ##  2   2013   1998
    ##  3   2013   1990
    ##  4   2013   2012
    ##  5   2013   1991
    ##  6   2013   2012
    ##  7   2013   2000
    ##  8   2013   1998
    ##  9   2013   2004
    ## 10   2013     NA
    ## # â€¦ with 336,766 more rows

çµåˆå¾Œã« `year` ãŒå­˜åœ¨ã™ã‚‹ã¨æ€ã£ã¦æ‰±ã£ã¦ã—ã¾ã„ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ãŒå¤šã„

``` r
flights %>% 
  left_join(planes, by = "tailnum") %>% 
  select(year)
```

    ## Error: Can't subset columns that don't exist.
    ## [31mx[39m Column `year` doesn't exist.

å·¦çµåˆãªã®ã§ã€èˆªç©ºä¾¿ãƒ‡ãƒ¼ã‚¿ã®æ©Ÿä½“ç•ªå· `flights$tailnum` ã«å¯¾ã—ã¦èˆªç©ºæ©Ÿãƒ‡ãƒ¼ã‚¿ã®æ©Ÿä½“ç•ªå· `planes$tailnum`
ãŒè¦‹ã¤ã‹ã‚‰ãªã„ç®‡æ‰€ã«ã¤ã„ã¦ã¯ã€èˆªç©ºä¾¿ãƒ‡ãƒ¼ã‚¿ `flights` ã®è¡Œã¯å…¨ã¦æ®‹ã‚Šèˆªç©ºæ©Ÿãƒ‡ãƒ¼ã‚¿ `planes`
ç”±æ¥ã®åˆ—ã¯ç©ºæ¬„ï¼ˆ`NA`ï¼‰ã¨ãªã‚‹ã€‚

ã‚¢ãƒ¡ãƒªã‚«ãƒ³èˆªç©º (ã‚³ãƒ¼ãƒ‰ â€œAAâ€) ã«ã¤ã„ã¦ã¯èˆªç©ºä¾¿ãƒ‡ãƒ¼ã‚¿ã® `flights$tailnum` ã«åéŒ²ã•ã‚Œã¦ã„ã‚‹å€¤ãŒ æ©Ÿä½“ç•ªå·ã§ã¯ãªã
fleet number ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€èˆªç©ºæ©Ÿãƒ‡ãƒ¼ã‚¿ `planes` ã¨ã®ç…§åˆãŒã§ããªã„ï¼ˆãƒ˜ãƒ«ãƒ— `help(planes)`
ã«èª¬æ˜ã‚ã‚Šï¼‰ã€‚ãã®ãŸã‚ã€ `left_join()` ã§çµåˆã™ã‚‹ã¨ `planes` ç”±æ¥ã®åˆ—ã¯å¤šãã®å€¤ãŒ `NA`
ã«ãªã‚‹ã€‚

``` r
flights %>% 
  left_join(planes, by = "tailnum") %>% 
  select(carrier, flight, tailnum, manufacturer, model) %>% 
  filter(carrier == "AA")
```

    ## # A tibble: 32,729 x 5
    ##    carrier flight tailnum manufacturer model  
    ##    <chr>    <int> <chr>   <chr>        <chr>  
    ##  1 AA        1141 N619AA  BOEING       757-223
    ##  2 AA         301 N3ALAA  <NA>         <NA>   
    ##  3 AA         707 N3DUAA  <NA>         <NA>   
    ##  4 AA        1895 N633AA  BOEING       757-223
    ##  5 AA        1837 N3EMAA  <NA>         <NA>   
    ##  6 AA         413 N3BAAA  <NA>         <NA>   
    ##  7 AA         303 N3CYAA  <NA>         <NA>   
    ##  8 AA         711 N3GKAA  <NA>         <NA>   
    ##  9 AA         305 N4WNAA  <NA>         <NA>   
    ## 10 AA        1815 N5FMAA  <NA>         <NA>   
    ## # â€¦ with 32,719 more rows

-----

## inner\_join() - å†…éƒ¨çµåˆ

SQL ã® INNER JOIN ã«ç›¸å½“ã™ã‚‹ã€‚

ï¼’ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ `flights` ã¨ `planes` ã¨ã‚’å†…éƒ¨çµåˆã™ã‚‹ã€‚çµåˆã‚­ãƒ¼ã«ã¯ `tailnum` ã‚’ä½¿ç”¨ã™ã‚‹:

``` r
flights %>% 
  inner_join(planes, by = "tailnum")
```

    ## # A tibble: 284,170 x 27
    ##    year.x month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
    ##     <int> <int> <int>    <int>          <int>     <dbl>    <int>          <int>
    ##  1   2013     1     1      517            515         2      830            819
    ##  2   2013     1     1      533            529         4      850            830
    ##  3   2013     1     1      542            540         2      923            850
    ##  4   2013     1     1      544            545        -1     1004           1022
    ##  5   2013     1     1      554            600        -6      812            837
    ##  6   2013     1     1      554            558        -4      740            728
    ##  7   2013     1     1      555            600        -5      913            854
    ##  8   2013     1     1      557            600        -3      709            723
    ##  9   2013     1     1      557            600        -3      838            846
    ## 10   2013     1     1      558            600        -2      849            851
    ## # â€¦ with 284,160 more rows, and 19 more variables: arr_delay <dbl>,
    ## #   carrier <chr>, flight <int>, tailnum <chr>, origin <chr>, dest <chr>,
    ## #   air_time <dbl>, distance <dbl>, hour <dbl>, minute <dbl>, time_hour <dttm>,
    ## #   year.y <int>, type <chr>, manufacturer <chr>, model <chr>, engines <int>,
    ## #   seats <int>, speed <int>, engine <chr>

å†…éƒ¨çµåˆãªã®ã§ `flights$tailnum` ã¨ `planes$tailnum` ã®åŒæ–¹ã«åŒã˜å€¤ãŒå­˜åœ¨ã™ã‚‹è¡Œã®ã¿ãŒæ®‹ã‚‹ã€‚

ã¤ã¾ã‚Šã€å†…éƒ¨çµåˆã§ã¯èˆªç©ºä¾¿ãƒ‡ãƒ¼ã‚¿ `flights` ã®æ©Ÿä½“ç•ªå· `tailnum` ãŒèˆªç©ºæ©Ÿãƒ‡ãƒ¼ã‚¿ `planes`
ã®ä¸­ã«è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ãã®è¡Œã¯æ®‹ã‚‰ãªã„ã€‚

-----

## ãã®ä»–ã® `_join` é–¢æ•°

  - `right_join(x, y)` â€” `left_join()` ã¨ã¯é€†ã«ã€å³è¾ºã®ãƒ‡ãƒ¼ã‚¿ `y`
    ã«ã‚­ãƒ¼ãŒå­˜åœ¨ã™ã‚‹è¡Œã ã‘ã‚’æ®‹ã™ã€‚SQL ã® RIGHT JOIN ã«ç›¸å½“ã€‚
  - `full_join(x, y)` â€” ä¸¡è¾º `x`, `y` ã®ç‰‡æ–¹ã«ã—ã‹ã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªãã¦ã‚‚ã™ã¹ã¦ã®è¡Œã‚’æ®‹ã™ã€‚SQL ã® FULL
    JOIN ã«ç›¸å½“ã€‚
  - `semi_join(x, y)` â€” `x` ã®ã†ã¡ã€ `y` ã«ã‚­ãƒ¼ãŒå­˜åœ¨ã™ã‚‹è¡Œã ã‘ã‚’æ®‹ã™ã€‚`left_join()` ã«ä¼¼ã¦ã„ã‚‹ãŒ
    `y` ã®åˆ—ã‚’çµåˆã—ãªã„ã€‚
  - `anti_join(x, y)` â€” `x` ã®ã†ã¡ã€ `y` ã«ã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„è¡Œã ã‘ã‚’æ®‹ã™ã€‚

ã“ã‚Œã‚‰ã®é–¢æ•°ã¯ã‚ã¾ã‚Šä½¿ã‚ãªã„ã€‚
