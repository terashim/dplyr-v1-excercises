---
title: "dplyr ver1 練習帳 - 2-1 集計"
author: "terashim"
date: "2020/7/1"
output: 
  md_document:
    variant: markdown_github
---

# 2-1 集計

```{r setup, include=FALSE}
# カスタムチャンクオプション out.lines を定義
# 参考 https://bookdown.org/yihui/rmarkdown-cookbook/hook-truncate.html
# save the built-in output hook
hook_output <- knitr::knit_hooks$get("output")

# set a new output hook to truncate text output
knitr::knit_hooks$set(output = function(x, options) {
  if (!is.null(n <- options$out.lines)) {
    x <- xfun::split_lines(x)
    if (length(x) > n) {
      # truncate the output
      x <- c(head(x, n/2), '....', tail(x, n/2 + 1))
    }
    x <- paste(x, collapse = "\n")
  }
  hook_output(x, options)
})
```


パッケージのロード

```{r}
library(dplyr)
library(nycflights13)
```

## 練習用データ

`nycflights13` の `flights` を使用する

```{r}
tibble::glimpse(flights)
```


```{r}
flights %>% head(10)
```


## `summarise()` で全体の平均値を取る

出発遅延時間 `dep_delay`, 距離 `distance`, 飛行時間 `air_time`
の平均値を計算して、それぞれ列名 `avg_dep_delay`, `avg_distance`, `avg_air_time` とする

```{r}
flights %>% 
  summarise(
    avg_distance = mean(distance, na.rm = TRUE),
    avg_dep_delay = mean(dep_delay, na.rm = TRUE),
    avg_air_time = mean(air_time, na.rm = TRUE)
  )
```

## `group_by()` と `summarise()` でグループごとに平均値を取る

航空会社 `carrier` でグループ化してから出発遅延時間 `dep_delay`, 距離 `distance`, 飛行時間 `air_time` の平均値を計算する

```{r out.lines=17}
flights %>% 
  group_by(carrier) %>% 
  summarise(
    avg_distance = mean(distance, na.rm = TRUE),
    avg_dep_delay = mean(dep_delay, na.rm = TRUE),
    avg_air_time = mean(air_time, na.rm = TRUE)
  )
```

ここで、列 `carrier` によるグループ化が `summarise()` によって解除される旨の警告メッセージが表示される。
これは `dplyr` バージョン 1.0.0 での変更点である。

